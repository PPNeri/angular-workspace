/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/**
 * @license
 * Copyright Workylab. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://raw.githubusercontent.com/workylab/materialize-angular/master/LICENSE
 */
import { Component, ContentChildren, ElementRef, EventEmitter, forwardRef, Input, Output, QueryList, Renderer2, ViewChild } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { supportedEvents, supportTouchEvents } from '../../utils/get-supported-events.util';
import { config } from '../../config';
import { SliderOptionComponent } from './slider-option/slider-option.component';
export class SliderComponent {
    /**
     * @param {?} renderer
     */
    constructor(renderer) {
        this.renderer = renderer;
        this.className = SliderComponent.defaultProps.className;
        this.disabled = SliderComponent.defaultProps.disabled;
        this.required = SliderComponent.defaultProps.required;
        this.showLabels = SliderComponent.defaultProps.showLabels;
        this.showTicks = SliderComponent.defaultProps.showTicks;
        this.value = SliderComponent.defaultProps.value;
        this.prefix = config.components.prefix;
        this.isFocused = false;
        this.supportedEvents = supportedEvents();
        this.onChangeEmitter = new EventEmitter();
        this.actionDown = this.actionDown.bind(this);
        this.actionMove = this.actionMove.bind(this);
        this.actionUp = this.actionUp.bind(this);
        this.update = this.update.bind(this);
        window.addEventListener(this.supportedEvents.resize, this.update);
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.sliderTrack.nativeElement.addEventListener(this.supportedEvents.down, this.actionDown);
    }
    /**
     * @return {?}
     */
    ngAfterContentInit() {
        this.update();
        this.options.changes.subscribe(this.update);
    }
    /**
     * @return {?}
     */
    update() {
        setTimeout((/**
         * @return {?}
         */
        () => {
            this.renderPositions();
            this.moveToValue(this.value, false);
        }), 0);
    }
    /**
     * @return {?}
     */
    renderPositions() {
        /** @type {?} */
        const pixelInterval = this.getPixelInterval();
        this.removeTicks();
        this.options.forEach((/**
         * @param {?} option
         * @param {?} index
         * @return {?}
         */
        (option, index) => {
            /** @type {?} */
            const leftSpace = pixelInterval * index;
            const { nativeElement } = option.templateRef;
            this.renderer.setStyle(nativeElement, 'left', `${leftSpace}px`);
            if (this.showTicks) {
                /** @type {?} */
                const tick = this.renderer.createElement('div');
                this.renderer.setStyle(tick, 'left', `${leftSpace}px`);
                this.renderer.addClass(tick, SliderComponent.tickClassName);
                this.renderer.appendChild(this.sliderTrackInterval.nativeElement, tick);
            }
        }));
    }
    /**
     * @return {?}
     */
    removeTicks() {
        const { nativeElement } = this.sliderTrackInterval;
        while (nativeElement.firstChild) {
            this.renderer.removeChild(nativeElement, nativeElement.firstChild);
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    actionDown(event) {
        if (!this.disabled) {
            /** @type {?} */
            const x = this.getXCoordinate(event, this.supportedEvents.down);
            this.animate(x, true);
            window.addEventListener(this.supportedEvents.up, this.actionUp);
            window.addEventListener(this.supportedEvents.move, this.actionMove);
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    actionMove(event) {
        /** @type {?} */
        const x = this.getXCoordinate(event, this.supportedEvents.move);
        this.value = this.getValueFromXCoordinate(x);
        this.animate(x, false);
    }
    /**
     * @param {?} event
     * @return {?}
     */
    actionUp(event) {
        window.removeEventListener(this.supportedEvents.up, this.actionUp);
        window.removeEventListener(this.supportedEvents.move, this.actionMove);
        this.renderer.setStyle(this.sliderIndicatorContainer.nativeElement, 'transitionDuration', null);
        /** @type {?} */
        const x = this.getXCoordinate(event, this.supportedEvents.up);
        this.value = this.getValueFromXCoordinate(x);
        this.onChangeEmitter.emit(this.value);
        this.onChange(this.value);
        this.moveToValue(this.value, true);
    }
    /**
     * @param {?} value
     * @param {?} hasAnimation
     * @return {?}
     */
    moveToValue(value, hasAnimation) {
        /** @type {?} */
        const options = this.options.toArray();
        /** @type {?} */
        const index = options.findIndex((/**
         * @param {?} option
         * @return {?}
         */
        option => option.value === value));
        /** @type {?} */
        const validatedIndex = index >= 0
            ? index
            : 0;
        /** @type {?} */
        const pixelInterval = this.getPixelInterval();
        /** @type {?} */
        const nextXCoordinate = validatedIndex * pixelInterval;
        this.animate(nextXCoordinate, hasAnimation);
    }
    /**
     * @param {?} value
     * @return {?}
     */
    activeOption(value) {
        this.options.forEach((/**
         * @param {?} item
         * @return {?}
         */
        item => {
            item.isActive = (item.value === value);
        }));
    }
    /**
     * @param {?} x
     * @return {?}
     */
    getValueFromXCoordinate(x) {
        /** @type {?} */
        const index = this.getIndexFromXCoordinate(x);
        /** @type {?} */
        const options = this.options.toArray();
        /** @type {?} */
        const value = options[index].value;
        return value;
    }
    /**
     * @param {?} x
     * @return {?}
     */
    getIndexFromXCoordinate(x) {
        /** @type {?} */
        const pixelInterval = this.getPixelInterval();
        if (pixelInterval) {
            /** @type {?} */
            const index = Math.round(x / pixelInterval);
            if (index >= 0 && index <= this.options.length) {
                return index;
            }
        }
        return 0;
    }
    /**
     * @param {?} event
     * @param {?} eventType
     * @return {?}
     */
    getXCoordinateByEventType(event, eventType) {
        if (supportTouchEvents()) {
            if (eventType === this.supportedEvents.up) {
                return event.changedTouches[0].clientX;
            }
            return event.touches[0].clientX;
        }
        return event.clientX;
    }
    /**
     * @param {?} event
     * @param {?} eventType
     * @return {?}
     */
    getXCoordinate(event, eventType) {
        /** @type {?} */
        const rect = this.sliderTrack.nativeElement.getBoundingClientRect();
        /** @type {?} */
        const xCoordinateEvent = this.getXCoordinateByEventType(event, eventType);
        /** @type {?} */
        const x = xCoordinateEvent - rect.left;
        if (x < 0) {
            return 0;
        }
        if (x > this.sliderTrack.nativeElement.offsetWidth) {
            return this.sliderTrack.nativeElement.offsetWidth;
        }
        return x;
    }
    /**
     * @return {?}
     */
    getPixelInterval() {
        /** @type {?} */
        const maxOptionsSize = this.options.length - 1;
        if (maxOptionsSize > 0) {
            return this.sliderTrack.nativeElement.offsetWidth / maxOptionsSize;
        }
        return 0;
    }
    /**
     * @param {?} x
     * @param {?} hasAnimation
     * @return {?}
     */
    animate(x, hasAnimation) {
        this.activeOption(this.value);
        /** @type {?} */
        const transitionDuration = hasAnimation
            ? null
            : '0ms';
        this.renderer.setStyle(this.sliderIndicatorContainer.nativeElement, 'transitionDuration', transitionDuration);
        this.renderer.setStyle(this.sliderIndicatorContainer.nativeElement, 'left', `${x}px`);
    }
    /**
     * @return {?}
     */
    onFocus() {
        if (!this.disabled) {
            this.isFocused = true;
            this.onTouched();
        }
    }
    /**
     * @return {?}
     */
    onBlur() {
        this.isFocused = false;
    }
    /**
     * @param {?} isDisabled
     * @return {?}
     */
    setDisabledState(isDisabled) {
        this.disabled = isDisabled;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    writeValue(value) {
        setTimeout((/**
         * @return {?}
         */
        () => {
            this.value = value;
            this.moveToValue(value, false);
        }), 0);
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    registerOnChange(fn) {
        this.onChange = fn;
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    registerOnTouched(fn) {
        this.onTouched = fn;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    onChange(value) { }
    /**
     * @return {?}
     */
    onTouched() { }
}
SliderComponent.tickClassName = config.components.prefix + '-slider-step';
SliderComponent.defaultProps = {
    className: '',
    disabled: false,
    required: false,
    showLabels: true,
    showTicks: false,
    value: null
};
SliderComponent.decorators = [
    { type: Component, args: [{
                providers: [{
                        multi: true,
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef((/**
                         * @return {?}
                         */
                        () => SliderComponent))
                    }],
                selector: `${config.components.prefix}-slider }`,
                template: "<div [ngClass]=\"[prefix + '-slider', className]\" [class.focused]=\"isFocused\" [class.disabled]=\"disabled\">\n\n  <div [ngClass]=\"prefix + '-slider-track-container'\" #sliderTrack [tabindex]=\"disabled ? '-1' : '0'\" (focus)=\"onFocus()\" (blur)=\"onBlur()\">\n    <div #sliderTrackInterval></div>\n\n    <div [ngClass]=\"prefix + '-slider-track'\" #sliderTrackBackground></div>\n\n    <div [ngClass]=\"prefix + '-slider-indicator-container'\" #sliderIndicatorContainer>\n      <ng-content select=\"materialize-slider-indicator\"></ng-content>\n    </div>\n  </div>\n\n  <div [ngClass]=\"prefix + '-slider-labels-container'\" *ngIf=\"showLabels\">\n    <ng-content select=\"materialize-slider-option\"></ng-content>\n  </div>\n</div>\n"
            }] }
];
/** @nocollapse */
SliderComponent.ctorParameters = () => [
    { type: Renderer2 }
];
SliderComponent.propDecorators = {
    options: [{ type: ContentChildren, args: [SliderOptionComponent,] }],
    Slider: [{ type: ViewChild, args: ['Slider', { static: true },] }],
    sliderIndicatorContainer: [{ type: ViewChild, args: ['sliderIndicatorContainer', { static: true },] }],
    sliderTrack: [{ type: ViewChild, args: ['sliderTrack', { static: true },] }],
    sliderTrackBackground: [{ type: ViewChild, args: ['sliderTrackBackground', { static: true },] }],
    sliderTrackInterval: [{ type: ViewChild, args: ['sliderTrackInterval', { static: true },] }],
    onChangeEmitter: [{ type: Output, args: ['onChange',] }],
    className: [{ type: Input }],
    disabled: [{ type: Input }],
    required: [{ type: Input }],
    showLabels: [{ type: Input }],
    showTicks: [{ type: Input }],
    value: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    SliderComponent.tickClassName;
    /** @type {?} */
    SliderComponent.defaultProps;
    /** @type {?} */
    SliderComponent.prototype.options;
    /** @type {?} */
    SliderComponent.prototype.Slider;
    /** @type {?} */
    SliderComponent.prototype.sliderIndicatorContainer;
    /** @type {?} */
    SliderComponent.prototype.sliderTrack;
    /** @type {?} */
    SliderComponent.prototype.sliderTrackBackground;
    /** @type {?} */
    SliderComponent.prototype.sliderTrackInterval;
    /** @type {?} */
    SliderComponent.prototype.onChangeEmitter;
    /** @type {?} */
    SliderComponent.prototype.className;
    /** @type {?} */
    SliderComponent.prototype.disabled;
    /** @type {?} */
    SliderComponent.prototype.required;
    /** @type {?} */
    SliderComponent.prototype.showLabels;
    /** @type {?} */
    SliderComponent.prototype.showTicks;
    /** @type {?} */
    SliderComponent.prototype.value;
    /** @type {?} */
    SliderComponent.prototype.prefix;
    /** @type {?} */
    SliderComponent.prototype.isFocused;
    /** @type {?} */
    SliderComponent.prototype.supportedEvents;
    /**
     * @type {?}
     * @private
     */
    SliderComponent.prototype.renderer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2xpZGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL21hdGVyaWFsaXplLWFuZ3VsYXIvIiwic291cmNlcyI6WyJhcHAvY29tcGxldGVkLWNvbXBvbmVudHMvc2xpZGVyL3NsaWRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFRQSxPQUFPLEVBR0wsU0FBUyxFQUNULGVBQWUsRUFDZixVQUFVLEVBQ1YsWUFBWSxFQUNaLFVBQVUsRUFDVixLQUFLLEVBQ0wsTUFBTSxFQUNOLFNBQVMsRUFDVCxTQUFTLEVBQ1QsU0FBUyxFQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBd0IsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsZUFBZSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDNUYsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUV0QyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQVloRixNQUFNLE9BQU8sZUFBZTs7OztJQWtDMUIsWUFBb0IsUUFBbUI7UUFBbkIsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQVo5QixjQUFTLEdBQVcsZUFBZSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUM7UUFDM0QsYUFBUSxHQUFZLGVBQWUsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO1FBQzFELGFBQVEsR0FBWSxlQUFlLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQztRQUMxRCxlQUFVLEdBQVksZUFBZSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUM7UUFDOUQsY0FBUyxHQUFZLGVBQWUsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDO1FBQzVELFVBQUssR0FBcUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUM7UUFFL0UsV0FBTSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO1FBTXZDLElB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bEQsK3VCQUFzQzthQUN2Qzs7OztZQWxCQyxTQUFTOzs7c0JBK0JSLGVBQWUsU0FBQyxxQkFBcUI7cUJBRXJDLFNBQVMsU0FBQyxRQUFRLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO3VDQUNwQyxTQUFTLFNBQUMsMEJBQTBCLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFOzBCQUN0RCxTQUFTLFNBQUMsYUFBYSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtvQ0FDekMsU0FBUyxTQUFDLHVCQUF1QixFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtrQ0FDbkQsU0FBUyxTQUFDLHFCQUFxQixFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTs4QkFFakQsTUFBTSxTQUFDLFVBQVU7d0JBRWpCLEtBQUs7dUJBQ0wsS0FBSzt1QkFDTCxLQUFLO3lCQUNMLEtBQUs7d0JBQ0wsS0FBSztvQkFDTCxLQUFLOzs7O0lBMUJOLDhCQUEwRTs7SUFFMUUsNkJBT0U7O0lBRUYsa0NBQWtGOztJQUVsRixpQ0FBMEQ7O0lBQzFELG1EQUE4Rjs7SUFDOUYsc0NBQW9FOztJQUNwRSxnREFBd0Y7O0lBQ3hGLDhDQUFvRjs7SUFFcEYsMENBQW9GOztJQUVwRixvQ0FBb0U7O0lBQ3BFLG1DQUFtRTs7SUFDbkUsbUNBQW1FOztJQUNuRSxxQ0FBdUU7O0lBQ3ZFLG9DQUFxRTs7SUFDckUsZ0NBQXNGOztJQUV0RixpQ0FBeUM7O0lBRXpDLG9DQUEwQjs7SUFDMUIsMENBQTZDOzs7OztJQUVqQyxtQ0FBMkIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgV29ya3lsYWIuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3dvcmt5bGFiL21hdGVyaWFsaXplLWFuZ3VsYXIvbWFzdGVyL0xJQ0VOU0VcbiAqL1xuXG5pbXBvcnQge1xuICBBZnRlckNvbnRlbnRJbml0LFxuICBBZnRlclZpZXdJbml0LFxuICBDb21wb25lbnQsXG4gIENvbnRlbnRDaGlsZHJlbixcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLFxuICBmb3J3YXJkUmVmLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBRdWVyeUxpc3QsXG4gIFJlbmRlcmVyMixcbiAgVmlld0NoaWxkXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE5HX1ZBTFVFX0FDQ0VTU09SIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgc3VwcG9ydGVkRXZlbnRzLCBzdXBwb3J0VG91Y2hFdmVudHMgfSBmcm9tICcuLi8uLi91dGlscy9nZXQtc3VwcG9ydGVkLWV2ZW50cy51dGlsJztcbmltcG9ydCB7IGNvbmZpZyB9IGZyb20gJy4uLy4uL2NvbmZpZyc7XG5pbXBvcnQgeyBTbGlkZXJNb2RlbCB9IGZyb20gJy4vc2xpZGVyLm1vZGVsJztcbmltcG9ydCB7IFNsaWRlck9wdGlvbkNvbXBvbmVudCB9IGZyb20gJy4vc2xpZGVyLW9wdGlvbi9zbGlkZXItb3B0aW9uLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBTdXBwb3J0ZWRFdmVudHNNb2RlbCB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvY29tbW9uL21vZGVscy9zdXBwb3J0ZWQtZXZlbnRzLm1vZGVsJztcblxuQENvbXBvbmVudCh7XG4gIHByb3ZpZGVyczogW3tcbiAgICBtdWx0aTogdHJ1ZSxcbiAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBTbGlkZXJDb21wb25lbnQpXG4gIH1dLFxuICBzZWxlY3RvcjogYCR7IGNvbmZpZy5jb21wb25lbnRzLnByZWZpeCB9LXNsaWRlciB9YCxcbiAgdGVtcGxhdGVVcmw6ICcuL3NsaWRlci5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgU2xpZGVyQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCwgQWZ0ZXJWaWV3SW5pdCwgQ29udHJvbFZhbHVlQWNjZXNzb3IsIFNsaWRlck1vZGVsIHtcbiAgc3RhdGljIHJlYWRvbmx5IHRpY2tDbGFzc05hbWUgPSBjb25maWcuY29tcG9uZW50cy5wcmVmaXggKyAnLXNsaWRlci1zdGVwJztcblxuICBzdGF0aWMgcmVhZG9ubHkgZGVmYXVsdFByb3BzOiBTbGlkZXJNb2RlbCA9IHtcbiAgICBjbGFzc05hbWU6ICcnLFxuICAgIGRpc2FibGVkOiBmYWxzZSxcbiAgICByZXF1aXJlZDogZmFsc2UsXG4gICAgc2hvd0xhYmVsczogdHJ1ZSxcbiAgICBzaG93VGlja3M6IGZhbHNlLFxuICAgIHZhbHVlOiBudWxsXG4gIH07XG5cbiAgQENvbnRlbnRDaGlsZHJlbihTbGlkZXJPcHRpb25Db21wb25lbnQpIG9wdGlvbnM6IFF1ZXJ5TGlzdDxTbGlkZXJPcHRpb25Db21wb25lbnQ+O1xuXG4gIEBWaWV3Q2hpbGQoJ1NsaWRlcicsIHsgc3RhdGljOiB0cnVlIH0pIFNsaWRlcjogRWxlbWVudFJlZjtcbiAgQFZpZXdDaGlsZCgnc2xpZGVySW5kaWNhdG9yQ29udGFpbmVyJywgeyBzdGF0aWM6IHRydWUgfSkgc2xpZGVySW5kaWNhdG9yQ29udGFpbmVyOiBFbGVtZW50UmVmO1xuICBAVmlld0NoaWxkKCdzbGlkZXJUcmFjaycsIHsgc3RhdGljOiB0cnVlIH0pIHNsaWRlclRyYWNrOiBFbGVtZW50UmVmO1xuICBAVmlld0NoaWxkKCdzbGlkZXJUcmFja0JhY2tncm91bmQnLCB7IHN0YXRpYzogdHJ1ZSB9KSBzbGlkZXJUcmFja0JhY2tncm91bmQ6IEVsZW1lbnRSZWY7XG4gIEBWaWV3Q2hpbGQoJ3NsaWRlclRyYWNrSW50ZXJ2YWwnLCB7IHN0YXRpYzogdHJ1ZSB9KSBzbGlkZXJUcmFja0ludGVydmFsOiBFbGVtZW50UmVmO1xuXG4gIEBPdXRwdXQoJ29uQ2hhbmdlJykgb25DaGFuZ2VFbWl0dGVyOiBFdmVudEVtaXR0ZXI8bnVtYmVyIHwgc3RyaW5nIHwgYm9vbGVhbiB8IG51bGw+O1xuXG4gIEBJbnB1dCgpIGNsYXNzTmFtZTogc3RyaW5nID0gU2xpZGVyQ29tcG9uZW50LmRlZmF1bHRQcm9wcy5jbGFzc05hbWU7XG4gIEBJbnB1dCgpIGRpc2FibGVkOiBib29sZWFuID0gU2xpZGVyQ29tcG9uZW50LmRlZmF1bHRQcm9wcy5kaXNhYmxlZDtcbiAgQElucHV0KCkgcmVxdWlyZWQ6IGJvb2xlYW4gPSBTbGlkZXJDb21wb25lbnQuZGVmYXVsdFByb3BzLnJlcXVpcmVkO1xuICBASW5wdXQoKSBzaG93TGFiZWxzOiBib29sZWFuID0gU2xpZGVyQ29tcG9uZW50LmRlZmF1bHRQcm9wcy5zaG93TGFiZWxzO1xuICBASW5wdXQoKSBzaG93VGlja3M6IGJvb2xlYW4gPSBTbGlkZXJDb21wb25lbnQuZGVmYXVsdFByb3BzLnNob3dUaWNrcztcbiAgQElucHV0KCkgdmFsdWU6IG51bWJlciB8IHN0cmluZyB8IGJvb2xlYW4gfCBudWxsID0gU2xpZGVyQ29tcG9uZW50LmRlZmF1bHRQcm9wcy52YWx1ZTtcblxuICBwdWJsaWMgcHJlZml4ID0gY29uZmlnLmNvbXBvbmVudHMucHJlZml4O1xuXG4gIHB1YmxpYyBpc0ZvY3VzZWQ6IGJvb2xlYW47XG4gIHB1YmxpYyBzdXBwb3J0ZWRFdmVudHM6IFN1cHBvcnRlZEV2ZW50c01vZGVsO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMikge1xuICAgIHRoaXMuaXNGb2N1c2VkID0gZmFsc2U7XG4gICAgdGhpcy5zdXBwb3J0ZWRFdmVudHMgPSBzdXBwb3J0ZWRFdmVudHMoKTtcbiAgICB0aGlzLm9uQ2hhbmdlRW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIHRoaXMuYWN0aW9uRG93biA9IHRoaXMuYWN0aW9uRG93bi5iaW5kKHRoaXMpO1xuICAgIHRoaXMuYWN0aW9uTW92ZSA9IHRoaXMuYWN0aW9uTW92ZS5iaW5kKHRoaXMpO1xuICAgIHRoaXMuYWN0aW9uVXAgPSB0aGlzLmFjdGlvblVwLmJpbmQodGhpcyk7XG4gICAgdGhpcy51cGRhdGUgPSB0aGlzLnVwZGF0ZS5iaW5kKHRoaXMpO1xuXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIodGhpcy5zdXBwb3J0ZWRFdmVudHMucmVzaXplLCB0aGlzLnVwZGF0ZSk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5zbGlkZXJUcmFjay5uYXRpdmVFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodGhpcy5zdXBwb3J0ZWRFdmVudHMuZG93biwgdGhpcy5hY3Rpb25Eb3duKTtcbiAgfVxuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcbiAgICB0aGlzLnVwZGF0ZSgpO1xuXG4gICAgdGhpcy5vcHRpb25zLmNoYW5nZXMuc3Vic2NyaWJlKHRoaXMudXBkYXRlKTtcbiAgfVxuXG4gIHVwZGF0ZSgpIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMucmVuZGVyUG9zaXRpb25zKCk7XG4gICAgICB0aGlzLm1vdmVUb1ZhbHVlKHRoaXMudmFsdWUsIGZhbHNlKTtcbiAgICB9LCAwKTtcbiAgfVxuXG4gIHJlbmRlclBvc2l0aW9ucygpIHtcbiAgICBjb25zdCBwaXhlbEludGVydmFsID0gdGhpcy5nZXRQaXhlbEludGVydmFsKCk7XG5cbiAgICB0aGlzLnJlbW92ZVRpY2tzKCk7XG5cbiAgICB0aGlzLm9wdGlvbnMuZm9yRWFjaCgob3B0aW9uLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgbGVmdFNwYWNlID0gcGl4ZWxJbnRlcnZhbCAqIGluZGV4O1xuICAgICAgY29uc3QgeyBuYXRpdmVFbGVtZW50IH0gPSBvcHRpb24udGVtcGxhdGVSZWY7XG5cbiAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUobmF0aXZlRWxlbWVudCwgJ2xlZnQnLCBgJHsgbGVmdFNwYWNlIH1weGApO1xuXG4gICAgICBpZiAodGhpcy5zaG93VGlja3MpIHtcbiAgICAgICAgY29uc3QgdGljayA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aWNrLCAnbGVmdCcsIGAkeyBsZWZ0U3BhY2UgfXB4YCk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGljaywgU2xpZGVyQ29tcG9uZW50LnRpY2tDbGFzc05hbWUpO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKHRoaXMuc2xpZGVyVHJhY2tJbnRlcnZhbC5uYXRpdmVFbGVtZW50LCB0aWNrKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHJlbW92ZVRpY2tzKCkge1xuICAgIGNvbnN0IHsgbmF0aXZlRWxlbWVudCB9ID0gdGhpcy5zbGlkZXJUcmFja0ludGVydmFsO1xuXG4gICAgd2hpbGUgKG5hdGl2ZUVsZW1lbnQuZmlyc3RDaGlsZCkge1xuICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZChuYXRpdmVFbGVtZW50LCBuYXRpdmVFbGVtZW50LmZpcnN0Q2hpbGQpO1xuICAgIH1cbiAgfVxuXG4gIGFjdGlvbkRvd24oZXZlbnQ6IGFueSkge1xuICAgIGlmICghdGhpcy5kaXNhYmxlZCkge1xuICAgICAgY29uc3QgeCA9IHRoaXMuZ2V0WENvb3JkaW5hdGUoZXZlbnQsIHRoaXMuc3VwcG9ydGVkRXZlbnRzLmRvd24pO1xuXG4gICAgICB0aGlzLmFuaW1hdGUoeCwgdHJ1ZSk7XG5cbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKHRoaXMuc3VwcG9ydGVkRXZlbnRzLnVwLCB0aGlzLmFjdGlvblVwKTtcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKHRoaXMuc3VwcG9ydGVkRXZlbnRzLm1vdmUsIHRoaXMuYWN0aW9uTW92ZSk7XG4gICAgfVxuICB9XG5cbiAgYWN0aW9uTW92ZShldmVudDogYW55KSB7XG4gICAgY29uc3QgeCA9IHRoaXMuZ2V0WENvb3JkaW5hdGUoZXZlbnQsIHRoaXMuc3VwcG9ydGVkRXZlbnRzLm1vdmUpO1xuXG4gICAgdGhpcy52YWx1ZSA9IHRoaXMuZ2V0VmFsdWVGcm9tWENvb3JkaW5hdGUoeCk7XG4gICAgdGhpcy5hbmltYXRlKHgsIGZhbHNlKTtcbiAgfVxuXG4gIGFjdGlvblVwKGV2ZW50OiBhbnkpIHtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcih0aGlzLnN1cHBvcnRlZEV2ZW50cy51cCwgdGhpcy5hY3Rpb25VcCk7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIodGhpcy5zdXBwb3J0ZWRFdmVudHMubW92ZSwgdGhpcy5hY3Rpb25Nb3ZlKTtcblxuICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGhpcy5zbGlkZXJJbmRpY2F0b3JDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ3RyYW5zaXRpb25EdXJhdGlvbicsIG51bGwpO1xuXG4gICAgY29uc3QgeCA9IHRoaXMuZ2V0WENvb3JkaW5hdGUoZXZlbnQsIHRoaXMuc3VwcG9ydGVkRXZlbnRzLnVwKTtcblxuICAgIHRoaXMudmFsdWUgPSB0aGlzLmdldFZhbHVlRnJvbVhDb29yZGluYXRlKHgpO1xuICAgIHRoaXMub25DaGFuZ2VFbWl0dGVyLmVtaXQodGhpcy52YWx1ZSk7XG4gICAgdGhpcy5vbkNoYW5nZSh0aGlzLnZhbHVlKTtcbiAgICB0aGlzLm1vdmVUb1ZhbHVlKHRoaXMudmFsdWUsIHRydWUpO1xuICB9XG5cbiAgbW92ZVRvVmFsdWUodmFsdWU6IG51bWJlciB8IHN0cmluZyB8IGJvb2xlYW4gfCBudWxsLCBoYXNBbmltYXRpb246IGJvb2xlYW4pIHtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5vcHRpb25zLnRvQXJyYXkoKTtcbiAgICBjb25zdCBpbmRleCA9IG9wdGlvbnMuZmluZEluZGV4KG9wdGlvbiA9PiBvcHRpb24udmFsdWUgPT09IHZhbHVlKTtcbiAgICBjb25zdCB2YWxpZGF0ZWRJbmRleCA9IGluZGV4ID49IDBcbiAgICAgID8gaW5kZXhcbiAgICAgIDogMDtcbiAgICBjb25zdCBwaXhlbEludGVydmFsID0gdGhpcy5nZXRQaXhlbEludGVydmFsKCk7XG4gICAgY29uc3QgbmV4dFhDb29yZGluYXRlID0gdmFsaWRhdGVkSW5kZXggKiBwaXhlbEludGVydmFsO1xuXG4gICAgdGhpcy5hbmltYXRlKG5leHRYQ29vcmRpbmF0ZSwgaGFzQW5pbWF0aW9uKTtcbiAgfVxuXG4gIGFjdGl2ZU9wdGlvbih2YWx1ZTogbnVtYmVyIHwgc3RyaW5nIHwgYm9vbGVhbiB8IG51bGwpIHtcbiAgICB0aGlzLm9wdGlvbnMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGl0ZW0uaXNBY3RpdmUgPSAoaXRlbS52YWx1ZSA9PT0gdmFsdWUpO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0VmFsdWVGcm9tWENvb3JkaW5hdGUoeDogbnVtYmVyKSB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmdldEluZGV4RnJvbVhDb29yZGluYXRlKHgpO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMudG9BcnJheSgpO1xuICAgIGNvbnN0IHZhbHVlID0gb3B0aW9uc1tpbmRleF0udmFsdWU7XG5cbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICBnZXRJbmRleEZyb21YQ29vcmRpbmF0ZSh4OiBudW1iZXIpIHtcbiAgICBjb25zdCBwaXhlbEludGVydmFsID0gdGhpcy5nZXRQaXhlbEludGVydmFsKCk7XG5cbiAgICBpZiAocGl4ZWxJbnRlcnZhbCkge1xuICAgICAgY29uc3QgaW5kZXggPSBNYXRoLnJvdW5kKHggLyBwaXhlbEludGVydmFsKTtcblxuICAgICAgaWYgKGluZGV4ID49IDAgJiYgaW5kZXggPD0gdGhpcy5vcHRpb25zLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gaW5kZXg7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIDA7XG4gIH1cblxuICBnZXRYQ29vcmRpbmF0ZUJ5RXZlbnRUeXBlKGV2ZW50OiBhbnksIGV2ZW50VHlwZTogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBpZiAoc3VwcG9ydFRvdWNoRXZlbnRzKCkpIHtcbiAgICAgIGlmIChldmVudFR5cGUgPT09IHRoaXMuc3VwcG9ydGVkRXZlbnRzLnVwKSB7XG4gICAgICAgIHJldHVybiBldmVudC5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRYO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZXZlbnQudG91Y2hlc1swXS5jbGllbnRYO1xuICAgIH1cblxuICAgIHJldHVybiBldmVudC5jbGllbnRYO1xuICB9XG5cbiAgZ2V0WENvb3JkaW5hdGUoZXZlbnQ6IGFueSwgZXZlbnRUeXBlOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZWN0ID0gdGhpcy5zbGlkZXJUcmFjay5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIGNvbnN0IHhDb29yZGluYXRlRXZlbnQgPSB0aGlzLmdldFhDb29yZGluYXRlQnlFdmVudFR5cGUoZXZlbnQsIGV2ZW50VHlwZSk7XG4gICAgY29uc3QgeCA9IHhDb29yZGluYXRlRXZlbnQgLSByZWN0LmxlZnQ7XG5cbiAgICBpZiAoeCA8IDApIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIGlmICh4ID4gdGhpcy5zbGlkZXJUcmFjay5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoKSB7XG4gICAgICByZXR1cm4gdGhpcy5zbGlkZXJUcmFjay5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoO1xuICAgIH1cblxuICAgIHJldHVybiB4O1xuICB9XG5cbiAgZ2V0UGl4ZWxJbnRlcnZhbCgpIHtcbiAgICBjb25zdCBtYXhPcHRpb25zU2l6ZSA9IHRoaXMub3B0aW9ucy5sZW5ndGggLSAxO1xuXG4gICAgaWYgKG1heE9wdGlvbnNTaXplID4gMCkge1xuICAgICAgcmV0dXJuIHRoaXMuc2xpZGVyVHJhY2submF0aXZlRWxlbWVudC5vZmZzZXRXaWR0aCAvIG1heE9wdGlvbnNTaXplO1xuICAgIH1cblxuICAgIHJldHVybiAwO1xuICB9XG5cbiAgYW5pbWF0ZSh4OiBudW1iZXIsIGhhc0FuaW1hdGlvbjogYm9vbGVhbikge1xuICAgIHRoaXMuYWN0aXZlT3B0aW9uKHRoaXMudmFsdWUpO1xuXG4gICAgY29uc3QgdHJhbnNpdGlvbkR1cmF0aW9uID0gaGFzQW5pbWF0aW9uXG4gICAgICA/IG51bGxcbiAgICAgIDogJzBtcyc7XG5cbiAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuc2xpZGVySW5kaWNhdG9yQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICd0cmFuc2l0aW9uRHVyYXRpb24nLCB0cmFuc2l0aW9uRHVyYXRpb24pO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGhpcy5zbGlkZXJJbmRpY2F0b3JDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ2xlZnQnLCBgJHsgeCB9cHhgKTtcbiAgfVxuXG4gIG9uRm9jdXMoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmRpc2FibGVkKSB7XG4gICAgICB0aGlzLmlzRm9jdXNlZCA9IHRydWU7XG5cbiAgICAgIHRoaXMub25Ub3VjaGVkKCk7XG4gICAgfVxuICB9XG5cbiAgb25CbHVyKCk6IHZvaWQge1xuICAgIHRoaXMuaXNGb2N1c2VkID0gZmFsc2U7XG4gIH1cblxuICBzZXREaXNhYmxlZFN0YXRlKGlzRGlzYWJsZWQ6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICB0aGlzLmRpc2FibGVkID0gaXNEaXNhYmxlZDtcbiAgfVxuXG4gIHdyaXRlVmFsdWUodmFsdWU6IG51bWJlciB8IHN0cmluZyB8IGJvb2xlYW4gfCBudWxsKTogdm9pZCB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLnZhbHVlID0gdmFsdWU7XG5cbiAgICAgIHRoaXMubW92ZVRvVmFsdWUodmFsdWUsIGZhbHNlKTtcbiAgICB9LCAwKTtcbiAgfVxuXG4gIHJlZ2lzdGVyT25DaGFuZ2UoZm46ICh2YWx1ZTogbnVtYmVyIHwgc3RyaW5nIHwgYm9vbGVhbiB8IG51bGwpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLm9uQ2hhbmdlID0gZm47XG4gIH1cblxuICByZWdpc3Rlck9uVG91Y2hlZChmbjogKCkgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRoaXMub25Ub3VjaGVkID0gZm47XG4gIH1cblxuICBvbkNoYW5nZSh2YWx1ZTogbnVtYmVyIHwgc3RyaW5nIHwgYm9vbGVhbiB8IG51bGwpOiB2b2lkIHt9XG5cbiAgb25Ub3VjaGVkKCk6IHZvaWQge31cbn1cbiJdfQ==